apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: spire-mgmt
type: Opaque
stringData:
  root-password: "demo-password"
  password: "spire-password"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-init
  namespace: spire-mgmt
data:
  schema.sql: |
    -- SPIFFE/SPIRE Workload Entry Management System Database Schema
    CREATE DATABASE IF NOT EXISTS spire_mgmt;
    USE spire_mgmt;

    -- Sites table
    CREATE TABLE IF NOT EXISTS sites (
        id VARCHAR(36) PRIMARY KEY,
        name VARCHAR(255) NOT NULL UNIQUE,
        region VARCHAR(50) NOT NULL,
        spire_server_address VARCHAR(255) NOT NULL,
        trust_domain VARCHAR(255) NOT NULL DEFAULT '',
        last_sync_at TIMESTAMP NULL,
        status ENUM('active', 'inactive') DEFAULT 'active',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    ) ENGINE=InnoDB;

    -- Workload entries table
    CREATE TABLE IF NOT EXISTS workload_entries (
        id VARCHAR(36) PRIMARY KEY,
        spiffe_id VARCHAR(512) NOT NULL UNIQUE,
        parent_id VARCHAR(512) NOT NULL,
        selectors JSON NOT NULL,
        ttl INT DEFAULT 3600,
        description TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        created_by VARCHAR(255) DEFAULT 'demo-user',
        INDEX idx_spiffe_id (spiffe_id),
        INDEX idx_parent_id (parent_id)
    ) ENGINE=InnoDB;

    -- Site workload entry assignments
    CREATE TABLE IF NOT EXISTS site_workload_entries (
        site_id VARCHAR(36),
        workload_entry_id VARCHAR(36),
        sync_status ENUM('pending', 'synced', 'failed', 'deleting') DEFAULT 'pending',
        spire_entry_id VARCHAR(255) DEFAULT NULL,
        last_sync_at TIMESTAMP NULL,
        sync_error TEXT,
        PRIMARY KEY (site_id, workload_entry_id),
        FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE,
        FOREIGN KEY (workload_entry_id) REFERENCES workload_entries(id) ON DELETE CASCADE,
        INDEX idx_sync_status (sync_status),
        INDEX idx_site_status (site_id, sync_status)
    ) ENGINE=InnoDB;

    -- Audit log
    CREATE TABLE IF NOT EXISTS audit_log (
        id BIGINT PRIMARY KEY AUTO_INCREMENT,
        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        actor VARCHAR(255) NOT NULL,
        action VARCHAR(50) NOT NULL,
        resource_type VARCHAR(50) NOT NULL,
        resource_id VARCHAR(255) NOT NULL,
        details JSON,
        INDEX idx_timestamp (timestamp),
        INDEX idx_actor (actor),
        INDEX idx_resource (resource_type, resource_id)
    ) ENGINE=InnoDB;

    -- Create user
    CREATE USER IF NOT EXISTS 'spire'@'%' IDENTIFIED BY 'spire-password';
    GRANT ALL PRIVILEGES ON spire_mgmt.* TO 'spire'@'%';
    FLUSH PRIVILEGES;
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: spire-mgmt
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: spire-mgmt
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: root-password
          ports:
            - containerPort: 3306
          volumeMounts:
            - name: mysql-storage
              mountPath: /var/lib/mysql
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            exec:
              command: ["mysqladmin", "ping", "-h", "localhost"]
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: mysql-storage
          persistentVolumeClaim:
            claimName: mysql-pvc
        - name: init-scripts
          configMap:
            name: mysql-init
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: spire-mgmt
spec:
  selector:
    app: mysql
  ports:
    - port: 3306
      targetPort: 3306
